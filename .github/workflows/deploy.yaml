name: Deploy

on:
  push:
    branches:
      - main
  workflow_dispatch: {}

permissions:
  id-token: write
  contents: read

env:
  AWS_REGION: eu-central-1
  SSM_ROLE_TO_ASSUME: arn:aws:iam::887016236946:role/github-terraform-matrix-homeline
  REPO_URL: ${{ github.server_url }}/${{ github.repository }}.git
  SSM_DOCUMENT_NAME: matrix-homeline-launcher

jobs:
  terraform:
    runs-on: ubuntu-latest

    outputs:
      instance_id: ${{ steps.tf_out.outputs.instance_id }}
      public_ip: ${{ steps.tf_out.outputs.public_ip }}

    env:
      TF_IN_AUTOMATION: "true"
      TF_VAR_aws_region: ${{ env.AWS_REGION }}
      TF_VAR_repo_url: ${{ env.REPO_URL }}
      TF_VAR_ssm_launcher_document_name: ${{ env.SSM_DOCUMENT_NAME }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.9.0

      - name: Configure AWS credentials (OIDC)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ env.SSM_ROLE_TO_ASSUME }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Terraform Init
        working-directory: ./terraform
        run: terraform init -input=false

      - name: Terraform Plan
        working-directory: ./terraform
        run: terraform plan -input=false

      - name: Terraform Apply
        working-directory: ./terraform
        run: terraform apply -input=false -auto-approve

      - name: Read Terraform outputs
        id: tf_out
        working-directory: ./terraform
        run: |
          echo "instance_id=$(terraform output -raw matrix_instance_id)" >> "$GITHUB_OUTPUT"
          echo "public_ip=$(terraform output -raw matrix_public_ip)" >> "$GITHUB_OUTPUT"

      - name: Publish Terraform outputs (Job Summary)
        run: |
          {
            echo "## Terraform Outputs"
            echo ""
            echo "| Key | Value |"
            echo "|---|---|"
            echo "| Instance ID | \`${{ steps.tf_out.outputs.instance_id }}\` |"
            echo "| Public IP | \`${{ steps.tf_out.outputs.public_ip }}\` |"
            echo ""
          } >> "$GITHUB_STEP_SUMMARY"

      - name: Wait for SSM to become available (max 5 minutes)
        shell: bash
        env:
          INSTANCE_ID: ${{ steps.tf_out.outputs.instance_id }}
        run: |
          set -euo pipefail

          aws ec2 wait instance-running --region "$AWS_REGION" --instance-ids "$INSTANCE_ID"

          for i in {1..20}; do   # 20 Ã— 15s = 5 minutes
            STATUS=$(aws ssm describe-instance-information \
              --region "$AWS_REGION" \
              --filters "Key=InstanceIds,Values=$INSTANCE_ID" \
              --query "InstanceInformationList[0].PingStatus" \
              --output text || true)

            if [[ "$STATUS" == "Online" ]]; then
              echo "SSM is online for instance $INSTANCE_ID"
              exit 0
            fi

            echo "Waiting for SSM... (status=${STATUS:-none})"
            sleep 15
          done

          echo "Timed out waiting for SSM to become available."
          exit 1

  deploy:
    runs-on: ubuntu-latest
    needs: terraform

    env:
      INSTANCE_ID: ${{ needs.terraform.outputs.instance_id }}
      REF: ${{ github.sha }}

    steps:
      - name: Configure AWS credentials (OIDC)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ env.SSM_ROLE_TO_ASSUME }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Send deploy command via SSM
        id: ssm
        shell: bash
        run: |
          set -euo pipefail

          echo "Instance: $INSTANCE_ID"
          echo "Repo: $REPO_URL"
          echo "Ref: $REF"
          echo "SSM Document: $SSM_DOCUMENT_NAME"

          COMMAND_ID=$(
            aws ssm send-command \
              --region "$AWS_REGION" \
              --document-name "$SSM_DOCUMENT_NAME" \
              --instance-ids "$INSTANCE_ID" \
              --parameters "RepoUrl=$REPO_URL,Ref=$REF" \
              --comment "matrix-homeline deploy from GitHub Actions" \
              --query "Command.CommandId" \
              --output text
          )

          echo "command_id=$COMMAND_ID" >> "$GITHUB_OUTPUT"
          echo "SSM CommandId: $COMMAND_ID"

      - name: Wait for deployment to finish + print logs on failure
        shell: bash
        env:
          COMMAND_ID: ${{ steps.ssm.outputs.command_id }}
        run: |
          set -euo pipefail

          echo "Waiting for SSM command $COMMAND_ID..."

          for i in {1..60}; do  # ~10 minutes (60 * 10s)
            STATUS=$(aws ssm get-command-invocation \
              --region "$AWS_REGION" \
              --command-id "$COMMAND_ID" \
              --instance-id "$INSTANCE_ID" \
              --query "Status" \
              --output text || true)

            case "$STATUS" in
              Success)
                echo "Deployment succeeded."
                exit 0
                ;;
              Failed|Cancelled|TimedOut)
                echo "Deployment finished with status: $STATUS"
                echo ""
                echo "----- STDOUT -----"
                aws ssm get-command-invocation \
                  --region "$AWS_REGION" \
                  --command-id "$COMMAND_ID" \
                  --instance-id "$INSTANCE_ID" \
                  --query "StandardOutputContent" \
                  --output text || true
                echo ""
                echo "----- STDERR -----"
                aws ssm get-command-invocation \
                  --region "$AWS_REGION" \
                  --command-id "$COMMAND_ID" \
                  --instance-id "$INSTANCE_ID" \
                  --query "StandardErrorContent" \
                  --output text || true
                exit 1
                ;;
              InProgress|Pending|Delayed|"")
                echo "Status: ${STATUS:-none} (poll $i/60)"
                sleep 10
                ;;
              *)
                echo "Status: $STATUS (poll $i/60)"
                sleep 10
                ;;
            esac
          done

          echo "Timed out waiting for deployment to finish."
          exit 1
